#!/bin/bash

# devopsfetch - DevOps information retrieval tool

# Function to display help
display_help() {
    echo "Usage: devopsfetch [OPTION] [ARGUMENT]"
    echo "Collect and display system information for DevOps purposes."
    echo
    echo "Options:"
    echo "  -p, --port [PORT]     Display active ports or info about a specific port"
    echo "  -d, --docker [NAME]   List Docker images/containers or info about a specific container"
    echo "  -n, --nginx [DOMAIN]  Display Nginx domains, proxy targets, configurations, and configuration files"
    echo "  -u, --users [USER]    List users and last login times or info about a specific user"
    echo "  -t, --time START END  Display activities within a specified time range"
    echo "  -h, --help            Display this help message"
    echo
    echo "Examples:"
    echo "  devopsfetch -p              # List all active ports"
    echo "  devopsfetch -p 80           # Show details for port 80"
    echo "  devopsfetch -d              # List all Docker images and containers"
    echo "  devopsfetch -d mycontainer  # Show details for 'mycontainer'"
    echo "  devopsfetch -n              # List all Nginx domains, proxy targets, configurations, and config files"
    echo "  devopsfetch -n example.com  # Show details for example.com"
    echo "  devopsfetch -u              # List all users and last login times"
    echo "  devopsfetch -u johndoe      # Show details for user 'johndoe'"
    echo "  devopsfetch -t '2023-01-01 00:00:00' '2023-01-31 23:59:59'"
    echo "                              # Show activities in January 2023"
}

# Function to format output as a table
format_table() {
    column -t -s $'\t'
}

# Function to display ports information
display_ports() {
    if [ -z "$1" ]; then
        echo "Active Ports and Services:"
        ss -tuln | awk 'NR>1 {print $5}' | awk -F: '{print $NF}' | sort -n | uniq | \
        while read port; do
            service=$(lsof -i :$port | awk 'NR>1 {print $1}' | head -1)
            echo -e "$port\t$service"
        done | format_table
    else
        echo "Details for Port $1:"
        lsof -i :$1 | awk 'NR>1 {print $1"\t"$2"\t"$3"\t"$9}' | format_table
    fi
}

# Function to display Docker information
display_docker() {
    if [ -z "$1" ]; then
        echo "Docker Images:"
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}" | format_table
        echo
        echo "Docker Containers:"
        docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}" | format_table
    else
        echo "Details for Container '$1':"
        docker inspect $1 | jq '.[0] | {Name: .Name, Image: .Config.Image, State: .State.Status, IP: .NetworkSettings.IPAddress, Ports: .NetworkSettings.Ports}'
    fi
}

# Function to display Nginx information
display_nginx() {
    if [ -z "$1" ]; then
        echo "Nginx Domains, Proxy Targets, Configurations, and Configuration Files:"
        grep -h 'server_name' /etc/nginx/sites-enabled/* | awk '{print $2}' | sed 's/;//' | \
        while read domain; do
            config_file=$(grep -Rl "server_name $domain" /etc/nginx/sites-enabled/)
            proxy_target=$(grep -A 10 "server_name $domain" "$config_file" | grep 'proxy_pass' | awk '{print $2}' | sed 's/;//')
            config_content=$(grep -A 20 "server_name $domain" "$config_file" | sed 's/^/    /')
            echo -e "$domain\t$proxy_target\t$config_content\t$config_file"
        done | format_table
    else
        echo "Nginx Configuration for $1:"
        config_file=$(grep -Rl "server_name $1" /etc/nginx/sites-enabled/)
        echo "Proxy Target(s):"
        grep -A 10 "server_name $1" "$config_file" | grep 'proxy_pass' | awk '{print $2}' | sed 's/;//'
        echo "Configuration:"
        grep -A 20 "server_name $1" "$config_file" | sed 's/^/    /'
        echo "Configuration File(s):"
        echo "$config_file"
    fi
}

# Function to display user information
display_users() {
    if [ -z "$1" ]; then
        echo "Users and Last Login Times:"
        last -w | awk '!seen[$1]++ {print $1"\t"$4" "$5" "$6" "$7}' | format_table
    else
        echo "Details for User '$1':"
        id $1
        echo "Last Login: $(last -w $1 | awk 'NR==1 {print $4, $5, $6, $7}')"
        echo "Groups: $(groups $1)"
    fi
}

# Function to display activities within a time range
# Function to display activities within a time range
display_time_range() {
    if [ $# -eq 0 ]; then
        echo "Invalid parameter. Please provide a start date and optionally an end date."
        return 1
    elif [ $# -eq 1 ]; then
        start=$(date -d "$1" +"%Y-%m-%d 00:00:00")
        end=$(date -d "$1 + 1 day" +"%Y-%m-%d 00:00:00")
    elif [ $# -eq 2 ]; then
        start=$(date -d "$1" +"%Y-%m-%d 00:00:00")
        end=$(date -d "$2 + 1 day" +"%Y-%m-%d 00:00:00")
    else
        echo "Invalid request. Please provide a start date and optionally an end date."
        return 1
    fi

    echo "Activities between $start and $end:"
    journalctl --since "$start" --until "$end" | tail -n 50
}


# Main script logic
case "$1" in
    -p|--port)
        display_ports "$2"
        ;;
    -d|--docker)
        display_docker "$2"
        ;;
    -n|--nginx)
        display_nginx "$2"
        ;;
    -u|--users)
        display_users "$2"
        ;;
    -t|--time)
	shift     
        display_time_range "$@"
        ;;
    -h|--help)
        display_help
        ;;
    *)
        echo "Invalid option. Use -h or --help for usage information."
        exit 1
        ;;
esac

